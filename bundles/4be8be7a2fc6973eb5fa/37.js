(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{1417:function(e,t,r){"use strict";r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return p}));var n=r(3),i=r(2),a=r(24);const o=window.crypto.subtle||window.crypto.webkitSubtle;function s(e,t){return{message:e,friendlyText:t}}function l(){return Object(i.b)("encryption|export_unsupported")}async function c(e,t){const r=function(e){const t=(new TextDecoder).decode(new Uint8Array(e));let r=0;for(;;){const e=t.indexOf("\n",r);if(e<0)throw new Error("Header line not found");const n=t.slice(r,e).trim();if(r=e+1,n===m)break}const n=r;for(;;){const e=t.indexOf("\n",r);if(t.slice(r,e<0?void 0:e).trim()===d)break;if(e<0)throw new Error("Trailer line not found");r=e+1}const i=r;return function(e){const t=window.atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}(t.slice(n,i))}(e),n=a.b.get().brand;if(r.length<1)throw s("Invalid file: too short",Object(i.b)("encryption|import_invalid_keyfile",{brand:n}));if(1!==r[0])throw s("Unsupported version",Object(i.b)("encryption|import_invalid_keyfile",{brand:n}));const c=r.length-69;if(c<0)throw s("Invalid file: too short",Object(i.b)("encryption|import_invalid_keyfile",{brand:n}));const p=r.subarray(1,17),h=r.subarray(17,33),y=r[33]<<24|r[34]<<16|r[35]<<8|r[36],b=r.subarray(37,37+c),f=r.subarray(-32),[w,g]=await u(p,y,t),E=r.subarray(0,-32);let _,v;try{_=await o.verify({name:"HMAC"},g,f,E)}catch(e){throw s("subtleCrypto.verify failed: "+e,l())}if(!_)throw s("hmac mismatch",Object(i.b)("encryption|import_invalid_passphrase"));try{v=await o.decrypt({name:"AES-CTR",counter:h,length:64},w,b)}catch(e){throw s("subtleCrypto.decrypt failed: "+e,l())}return(new TextDecoder).decode(new Uint8Array(v))}async function p(e,t,r){const n=(r=r||{}).kdf_rounds||5e5,i=new Uint8Array(16);window.crypto.getRandomValues(i);const a=new Uint8Array(16);window.crypto.getRandomValues(a),a[8]&=127;const[c,p]=await u(i,n,t),y=(new TextEncoder).encode(e);let b;try{b=await o.encrypt({name:"AES-CTR",counter:a,length:64},c,y)}catch(e){throw s("subtleCrypto.encrypt failed: "+e,l())}const f=new Uint8Array(b),w=1+i.length+a.length+4+f.length+32,g=new Uint8Array(w);let E=0;g[E++]=1,g.set(i,E),E+=i.length,g.set(a,E),E+=a.length,g[E++]=n>>24,g[E++]=n>>16&255,g[E++]=n>>8&255,g[E++]=255&n,g.set(f,E),E+=f.length;const _=g.subarray(0,E);let v;try{v=await o.sign({name:"HMAC"},p,_)}catch(e){throw s("subtleCrypto.sign failed: "+e,l())}const C=new Uint8Array(v);return g.set(C,E),function(e){const t=96,r=Math.ceil(e.length/t),n=new Array(r+3);n[0]=m;let i,a=0;for(i=1;i<=r;i++)n[i]=h(e.subarray(a,a+t)),a+=t;return n[i++]=d,n[i]="",(new TextEncoder).encode(n.join("\n")).buffer}(g)}async function u(e,t,r){const i=new Date;let a,c;try{a=await o.importKey("raw",(new TextEncoder).encode(r),{name:"PBKDF2"},!1,["deriveBits"])}catch(e){throw s("subtleCrypto.importKey failed: "+e,l())}try{c=await o.deriveBits({name:"PBKDF2",salt:e,iterations:t,hash:"SHA-512"},a,512)}catch(e){throw s("subtleCrypto.deriveBits failed: "+e,l())}const p=new Date;n.a.log("E2e import/export: deriveKeys took "+(p.getTime()-i.getTime())+"ms");const u=c.slice(0,32),m=c.slice(32),d=o.importKey("raw",u,{name:"AES-CTR"},!1,["encrypt","decrypt"]).catch((e=>{throw s("subtleCrypto.importKey failed for AES key: "+e,l())})),h=o.importKey("raw",m,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]).catch((e=>{throw s("subtleCrypto.importKey failed for HMAC key: "+e,l())}));return Promise.all([d,h])}const m="-----BEGIN MEGOLM SESSION DATA-----",d="-----END MEGOLM SESSION DATA-----";function h(e){const t=String.fromCharCode.apply(null,Array.from(e));return window.btoa(t)}},1701:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return d}));var n=r(1),i=r.n(n),a=r(0),o=r.n(a),s=r(3),l=r(1417),c=r(2),p=r(34),u=r(48);var m=function(e){return e.Edit="edit",e.Importing="importing",e}(m||{});class d extends o.a.Component{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"file",Object(a.createRef)()),i()(this,"onFormChange",(()=>{var e;const t=null===(e=this.file.current)||void 0===e?void 0:e.files;this.setState({enableSubmit:""!==this.state.passphrase&&!(null==t||!t.length)})})),i()(this,"onPassphraseChange",(e=>{this.setState({passphrase:e.target.value},this.onFormChange)})),i()(this,"onFormSubmit",(e=>{var t,r;e.preventDefault();const n=null===(t=this.file.current)||void 0===t||null===(r=t.files)||void 0===r?void 0:r[0];return n&&this.startImport(n,this.state.passphrase),!1})),i()(this,"onCancelClick",(e=>(e.preventDefault(),this.props.onFinished(!1),!1))),this.state={enableSubmit:!1,phase:m.Edit,errStr:null,passphrase:""}}componentWillUnmount(){this.unmounted=!0}startImport(e,t){return this.setState({errStr:null,phase:m.Importing}),function(e){return new Promise(((t,r)=>{const n=new FileReader;n.onload=e=>{var n;null!==(n=e.target)&&void 0!==n&&n.result?t(e.target.result):r(new Error("Failed to read file due to unknown error"))},n.onerror=r,n.readAsArrayBuffer(e)}))}(e).then((e=>l.a(e,t))).then((e=>this.props.matrixClient.importRoomKeys(JSON.parse(e)))).then((()=>{this.props.onFinished(!0)})).catch((e=>{if(s.a.error("Error importing e2e keys:",e),this.unmounted)return;const t=e.friendlyText||Object(c.b)("error|unknown");this.setState({errStr:t,phase:m.Edit})}))}render(){const e=this.state.phase!==m.Edit;return o.a.createElement(p.a,{className:"mx_importE2eKeysDialog",onFinished:this.props.onFinished,title:Object(c.b)("settings|key_export_import|import_title")},o.a.createElement("form",{onSubmit:this.onFormSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.b)("settings|key_export_import|import_description_1")),o.a.createElement("p",null,Object(c.b)("settings|key_export_import|import_description_2")),o.a.createElement("div",{className:"error"},this.state.errStr),o.a.createElement("div",{className:"mx_E2eKeysDialog_inputTable"},o.a.createElement("div",{className:"mx_E2eKeysDialog_inputRow"},o.a.createElement("div",{className:"mx_E2eKeysDialog_inputLabel"},o.a.createElement("label",{htmlFor:"importFile"},Object(c.b)("settings|key_export_import|file_to_import"))),o.a.createElement("div",{className:"mx_E2eKeysDialog_inputCell"},o.a.createElement("input",{ref:this.file,id:"importFile",type:"file",autoFocus:!0,onChange:this.onFormChange,disabled:e}))),o.a.createElement("div",{className:"mx_E2eKeysDialog_inputRow"},o.a.createElement(u.a,{label:Object(c.b)("settings|key_export_import|enter_passphrase"),value:this.state.passphrase,onChange:this.onPassphraseChange,size:64,type:"password",disabled:e})))),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(c.b)("action|import"),disabled:!this.state.enableSubmit||e}),o.a.createElement("button",{onClick:this.onCancelClick,disabled:e},Object(c.b)("action|cancel")))))}}}}]);
//# sourceMappingURL=37.js.map