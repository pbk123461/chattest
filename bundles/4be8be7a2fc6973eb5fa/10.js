(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{1417:function(e,t,r){"use strict";r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return p}));var n=r(3),s=r(2),a=r(24);const o=window.crypto.subtle||window.crypto.webkitSubtle;function i(e,t){return{message:e,friendlyText:t}}function l(){return Object(s.b)("encryption|export_unsupported")}async function c(e,t){const r=function(e){const t=(new TextDecoder).decode(new Uint8Array(e));let r=0;for(;;){const e=t.indexOf("\n",r);if(e<0)throw new Error("Header line not found");const n=t.slice(r,e).trim();if(r=e+1,n===h)break}const n=r;for(;;){const e=t.indexOf("\n",r);if(t.slice(r,e<0?void 0:e).trim()===u)break;if(e<0)throw new Error("Trailer line not found");r=e+1}const s=r;return function(e){const t=window.atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}(t.slice(n,s))}(e),n=a.b.get().brand;if(r.length<1)throw i("Invalid file: too short",Object(s.b)("encryption|import_invalid_keyfile",{brand:n}));if(1!==r[0])throw i("Unsupported version",Object(s.b)("encryption|import_invalid_keyfile",{brand:n}));const c=r.length-69;if(c<0)throw i("Invalid file: too short",Object(s.b)("encryption|import_invalid_keyfile",{brand:n}));const p=r.subarray(1,17),m=r.subarray(17,33),y=r[33]<<24|r[34]<<16|r[35]<<8|r[36],f=r.subarray(37,37+c),w=r.subarray(-32),[b,_]=await d(p,y,t),g=r.subarray(0,-32);let E,x;try{E=await o.verify({name:"HMAC"},_,w,g)}catch(e){throw i("subtleCrypto.verify failed: "+e,l())}if(!E)throw i("hmac mismatch",Object(s.b)("encryption|import_invalid_passphrase"));try{x=await o.decrypt({name:"AES-CTR",counter:m,length:64},b,f)}catch(e){throw i("subtleCrypto.decrypt failed: "+e,l())}return(new TextDecoder).decode(new Uint8Array(x))}async function p(e,t,r){const n=(r=r||{}).kdf_rounds||5e5,s=new Uint8Array(16);window.crypto.getRandomValues(s);const a=new Uint8Array(16);window.crypto.getRandomValues(a),a[8]&=127;const[c,p]=await d(s,n,t),y=(new TextEncoder).encode(e);let f;try{f=await o.encrypt({name:"AES-CTR",counter:a,length:64},c,y)}catch(e){throw i("subtleCrypto.encrypt failed: "+e,l())}const w=new Uint8Array(f),b=1+s.length+a.length+4+w.length+32,_=new Uint8Array(b);let g=0;_[g++]=1,_.set(s,g),g+=s.length,_.set(a,g),g+=a.length,_[g++]=n>>24,_[g++]=n>>16&255,_[g++]=n>>8&255,_[g++]=255&n,_.set(w,g),g+=w.length;const E=_.subarray(0,g);let x;try{x=await o.sign({name:"HMAC"},p,E)}catch(e){throw i("subtleCrypto.sign failed: "+e,l())}const v=new Uint8Array(x);return _.set(v,g),function(e){const t=96,r=Math.ceil(e.length/t),n=new Array(r+3);n[0]=h;let s,a=0;for(s=1;s<=r;s++)n[s]=m(e.subarray(a,a+t)),a+=t;return n[s++]=u,n[s]="",(new TextEncoder).encode(n.join("\n")).buffer}(_)}async function d(e,t,r){const s=new Date;let a,c;try{a=await o.importKey("raw",(new TextEncoder).encode(r),{name:"PBKDF2"},!1,["deriveBits"])}catch(e){throw i("subtleCrypto.importKey failed: "+e,l())}try{c=await o.deriveBits({name:"PBKDF2",salt:e,iterations:t,hash:"SHA-512"},a,512)}catch(e){throw i("subtleCrypto.deriveBits failed: "+e,l())}const p=new Date;n.a.log("E2e import/export: deriveKeys took "+(p.getTime()-s.getTime())+"ms");const d=c.slice(0,32),h=c.slice(32),u=o.importKey("raw",d,{name:"AES-CTR"},!1,["encrypt","decrypt"]).catch((e=>{throw i("subtleCrypto.importKey failed for AES key: "+e,l())})),m=o.importKey("raw",h,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]).catch((e=>{throw i("subtleCrypto.importKey failed for HMAC key: "+e,l())}));return Promise.all([u,m])}const h="-----BEGIN MEGOLM SESSION DATA-----",u="-----END MEGOLM SESSION DATA-----";function m(e){const t=String.fromCharCode.apply(null,Array.from(e));return window.btoa(t)}},1682:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return f}));var n=r(1),s=r.n(n),a=r(1372),o=r.n(a),i=r(0),l=r.n(i),c=r(3),p=r(2),d=r(1417),h=r(34),u=r(1361),m=r(1413),y=function(e){return e.Edit="edit",e.Exporting="exporting",e}(y||{});class f extends l.a.Component{constructor(e){super(e),s()(this,"fieldPassword",null),s()(this,"fieldPasswordConfirm",null),s()(this,"unmounted",!1),s()(this,"onPassphraseFormSubmit",(async e=>{if(e.preventDefault(),!await this.verifyFieldsBeforeSubmit())return;if(this.unmounted)return;const t=this.state.passphrase1;this.startExport(t)})),s()(this,"onCancelClick",(e=>(e.preventDefault(),this.props.onFinished(!1),!1))),s()(this,"onPassphraseChange",((e,t)=>{this.setState({[t]:e.target.value})})),this.state={phase:y.Edit,errStr:null,passphrase1:"",passphrase2:""}}componentWillUnmount(){this.unmounted=!0}async verifyFieldsBeforeSubmit(){const e=[this.fieldPassword,this.fieldPasswordConfirm],t=[];for(const r of e){if(!r)continue;await r.validate({allowEmpty:!1})||t.push(r)}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}startExport(e){Promise.resolve().then((()=>this.props.matrixClient.exportRoomKeys())).then((t=>d.b(JSON.stringify(t),e))).then((e=>{const t=new Blob([e],{type:"text/plain;charset=us-ascii"});o.a.saveAs(t,"element-keys.txt"),this.props.onFinished(!0)})).catch((e=>{if(c.a.error("Error exporting e2e keys:",e),this.unmounted)return;const t=e.friendlyText||Object(p.b)("error|unknown");this.setState({errStr:t,phase:y.Edit})})),this.setState({errStr:null,phase:y.Exporting})}render(){const e=this.state.phase===y.Exporting;return l.a.createElement(h.a,{className:"mx_exportE2eKeysDialog",onFinished:this.props.onFinished,title:Object(p.b)("settings|key_export_import|export_title")},l.a.createElement("form",{onSubmit:this.onPassphraseFormSubmit},l.a.createElement("div",{className:"mx_Dialog_content"},l.a.createElement("p",null,Object(p.b)("settings|key_export_import|export_description_1")),l.a.createElement("p",null,Object(p.b)("settings|key_export_import|export_description_2")),l.a.createElement("div",{className:"error"},this.state.errStr),l.a.createElement("div",{className:"mx_E2eKeysDialog_inputTable"},l.a.createElement("div",{className:"mx_E2eKeysDialog_inputRow"},l.a.createElement(u.a,{minScore:3,label:Object(p.d)("settings|key_export_import|enter_passphrase"),labelEnterPassword:Object(p.d)("settings|key_export_import|enter_passphrase"),labelStrongPassword:Object(p.d)("settings|key_export_import|phrase_strong_enough"),labelAllowedButUnsafe:Object(p.d)("settings|key_export_import|phrase_strong_enough"),value:this.state.passphrase1,onChange:e=>this.onPassphraseChange(e,"passphrase1"),autoFocus:!0,size:64,type:"password",disabled:e,autoComplete:"new-password",fieldRef:e=>this.fieldPassword=e})),l.a.createElement("div",{className:"mx_E2eKeysDialog_inputRow"},l.a.createElement(m.a,{password:this.state.passphrase1,label:Object(p.d)("settings|key_export_import|confirm_passphrase"),labelRequired:Object(p.d)("settings|key_export_import|phrase_cannot_be_empty"),labelInvalid:Object(p.d)("settings|key_export_import|phrase_must_match"),value:this.state.passphrase2,onChange:e=>this.onPassphraseChange(e,"passphrase2"),size:64,type:"password",disabled:e,autoComplete:"new-password",fieldRef:e=>this.fieldPasswordConfirm=e})))),l.a.createElement("div",{className:"mx_Dialog_buttons"},l.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(p.b)("action|export"),disabled:e}),l.a.createElement("button",{onClick:this.onCancelClick,disabled:e},Object(p.b)("action|cancel")))))}}}}]);
//# sourceMappingURL=10.js.map