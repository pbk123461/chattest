(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{1486:function(e,t,n){"use strict";n.r(t),n.d(t,"sendMessage",(function(){return R})),n.d(t,"editMessage",(function(){return P}));var a=n(18),r=n.n(a),o=n(4),i=n(103),c=n(5),s=n(360),l=n(217),d=n(421),m=n(653),u=n(9),b=n(354),p=n(1368),g=n(1),f=n.n(g),y=n(1393),O=n(46),v=n(141),j=n(269);function E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?E(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):E(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const C="/me ";const T=e=>e instanceof o.MatrixEvent;async function _(e,t,{relation:n,replyToEvent:a,permalinkCreator:r,includeReplyLegacyFallback:i=!0,editedEvent:s}){const l=T(s),d=l?Boolean(s.replyEventId):T(a),m=l&&d,u=e.startsWith(C);u&&(e=e.slice(C.length)),e.startsWith("//")&&(e=e.slice(1));const b=t?await Object(y.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const n=Object(O.h)(t);Object(j.a)(n)&&Object(j.a)(n.roomIdOrAlias)&&e.replaceWith(n.roomIdOrAlias);break}}})),t.body.innerHTML}(e),p=m&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const n=t.split("\n").map((e=>e.trim()));return n.length>2&&n[0].startsWith("> ")&&0===n[1].length?`${n[0]}\n\n`:""}(s)||"",g=m&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(s)||"",f={msgtype:u?o.MsgType.Emote:o.MsgType.Text,body:l?`${p} * ${b}`:b},E=c.b.getValue("MessageComposerInput.useMarkdown"),_=t?e:E?await Object(y.plainToRich)(e,!0):null;_&&(f.format="org.matrix.custom.html",f.formatted_body=l?`${g} * ${_}`:_),l&&(f["m.new_content"]={msgtype:f.msgtype,body:b},_&&(f["m.new_content"].format="org.matrix.custom.html",f["m.new_content"].formatted_body=_));return function(e,t){t&&(e["m.relates_to"]=h(h({},e["m.relates_to"]||{}),t))}(f,l?h(h({},n),{},{rel_type:"m.replace",event_id:s.getId()}):n),!l&&a&&r&&Object(v.a)(f,a,{permalinkCreator:r,includeLegacyFallback:i}),f}var k=n(126),w=n(247),x=n(13),M=n(350);const S=["roomContext","mxClient"];async function R(e,t,n){var a;let{roomContext:b,mxClient:p}=n,g=r()(n,S);const{relation:f,replyToEvent:y,permalinkCreator:O}=g,{room:j}=b,E=null==j?void 0:j.roomId;if(!E)return;const h={eventName:"Composer",isEditing:!1,isLocation:!1,isReply:Boolean(y),inThread:(null==f?void 0:f.rel_type)===o.THREAD_RELATION_TYPE.name};i.a.instance.trackEvent(h);let T=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(C)){const{cmd:t,args:n}=Object(k.d)(e);if(t){const e=(null==f?void 0:f.rel_type)===o.THREAD_RELATION_TYPE.name?null==f?void 0:f.event_id:null;let a;if([T,a]=await Object(w.c)(p,t,n,E,null!=e?e:null),!a)return;if(!T||t.category!==k.a.messages&&t.category!==k.a.effects)return;var R,P;Object(M.b)(T,f),y&&Object(v.a)(T,y,{permalinkCreator:O,includeLegacyFallback:null===(R=null===(P=T.msgtype)||void 0===P?void 0:P.startsWith("m."))||void 0===R||R})}else{const t=await Object(w.d)(e);if(u.a.dispatch({action:x.a.FocusAComposer,context:b.timelineRenderingType}),!t)return}}if(null!==(a=T)&&void 0!==a||(T=await _(e,t,g)),!T.body.trim())return;c.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(s.a)(T);const A=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===o.THREAD_RELATION_TYPE.name?f.event_id:null,D=Object(l.a)(E,(e=>p.sendMessage(e,A,T)),p);return y&&u.a.dispatch({action:"reply_to_event",event:null,context:b.timelineRenderingType}),u.a.dispatch({action:"message_sent"}),d.CHAT_EFFECTS.forEach((e=>{if(T&&Object(m.containsEmoji)(T,e.emojis)){(null==f?void 0:f.rel_type)!==o.THREAD_RELATION_TYPE.name&&u.a.dispatch({action:`effects.${e.command}`})}})),c.b.getValue("Performance.addSendMessageTimingMetadata")&&D.then((e=>{Object(s.b)(p,E,e.event_id)})),c.b.getValue("scrollToBottomOnMessageSent")&&u.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:b.timelineRenderingType}),D}async function P(e,{roomContext:t,mxClient:n,editorStateTransfer:a}){const r=a.getEvent();i.a.instance.trackEvent({eventName:"Composer",isEditing:!0,isLocation:!1,inThread:Boolean(null==r?void 0:r.getThread()),isReply:Boolean(r.replyEventId)});const o=await _(e,!0,{editedEvent:r}),c=o["m.new_content"];if(""===(null==c?void 0:c.body))return Object(p.a)(n,a),void Object(b.a)({mxEvent:r,onCloseDialog:()=>{Object(p.b)(t)}});let s;const l=r.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(c,a)&&l){Object(p.a)(n,a);const e=a.getEvent().threadRootId||null;s=n.sendMessage(l,e,o),u.a.dispatch({action:"message_sent"})}return Object(p.b)(t),s}},1704:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return P}));var a=n(16),r=n.n(a),o=n(18),i=n.n(o),c=n(0),s=n.n(c),l=n(12),d=n.n(l),m=n(1483),u=n(2),b=n(10);function p({onCancelClick:e,onSaveClick:t,isSaveDisabled:n=!1}){return s.a.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},s.a.createElement(b.a,{kind:"secondary",onClick:e},Object(u.b)("action|cancel")),s.a.createElement(b.a,{kind:"primary",onClick:t,disabled:n},Object(u.b)("action|save")))}var g=n(9),f=n(13),y=n(27),O=n(649),v=n(1366),j=n(428),E=n(1367),h=n(1356);var C=n(22),T=n(1368),_=n(1486);var k=n(323),w=n(49),x=n(5);function M(e){const t=Object(y.c)(),n=Object(C.b)();return Object(c.useMemo)((()=>{if(e&&t.room&&n)return function(e,t,n){const a=new w.a(t,n);let r=[];if(e.hasEditorState()){const t=e.getSerializedParts();null!==t&&(r=t.map((e=>a.deserializePart(e))))}else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);r=Object(k.b)(e.getEvent(),a,{shouldEscape:x.b.getValue("MessageComposerInput.useMarkdown")})}return r.reduce(((e,t)=>e+(null==t?void 0:t.text)),"")}(e,t.room,n)}),[e,t,n])}const S=["editorStateTransfer","className"],R=Object(c.forwardRef)((function({disabled:e=!1,composerFunctions:t},n){return function(e,t,n){const a=Object(y.c)(),r=Object(h.c)(),o=Object(c.useRef)(null),i=Object(c.useCallback)((i=>{var c;if(e||!t.current)return;const s=null!==(c=i.context)&&void 0!==c?c:y.a.Room;switch(i.action){case f.a.FocusEditMessageComposer:Object(v.a)(t,s,a,o);break;case f.a.ComposerInsert:if(i.timelineRenderingType!==a.timelineRenderingType)break;if(i.composerType!==j.a.Edit)break;i.text&&Object(E.d)(r.selection).then((()=>n.insertText(i.text)))}}),[e,t,n,o,a,r]);Object(O.a)(g.a,i)}(e,n,t),null}));function P(e){let{editorStateTransfer:t,className:n}=e,a=i()(e,S);const o=Object(c.useRef)(Object(h.b)({editorStateTransfer:t})),l=M(t),u=!t||void 0!==l,{editMessage:b,endEditing:g,onChange:f,isSaveDisabled:O}=function(e,t){const n=Object(y.c)(),a=Object(C.b)(),[r,o]=Object(c.useState)(!0),[i,s]=Object(c.useState)(t);return{onChange:Object(c.useCallback)((e=>{s(e),o((n=>n&&e===t))}),[t]),editMessage:Object(c.useCallback)((async()=>{if(void 0!==a&&void 0!==i)return Object(_.editMessage)(i,{roomContext:n,mxClient:a,editorStateTransfer:e})}),[i,n,a,e]),endEditing:Object(c.useCallback)((()=>Object(T.b)(n)),[n]),isSaveDisabled:r}}(t,l);return u?s.a.createElement(h.a.Provider,{value:o.current},s.a.createElement(m.a,r()({className:d()("mx_EditWysiwygComposer",n),initialContent:l,onChange:f,onSend:b},a),((e,t)=>s.a.createElement(s.a.Fragment,null,s.a.createElement(R,{disabled:a.disabled,ref:e,composerFunctions:t}),s.a.createElement(p,{onCancelClick:g,onSaveClick:b,isSaveDisabled:O}))))):s.a.createElement(s.a.Fragment,null)}}}]);
//# sourceMappingURL=38.js.map